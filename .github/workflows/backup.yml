# (Optional) quick connection test â€” paste this just before the dump
- name: psql connectivity check
  env:
    PGHOST:     ${{ secrets.PGHOST }}
    PGPORT:     ${{ secrets.PGPORT }}
    PGUSER:     ${{ secrets.PGUSER }}
    PGPASSWORD: ${{ secrets.PGPASSWORD }}
    PGDATABASE: ${{ secrets.PGDATABASE }}
    PGSSLMODE:  require
  run: |
    docker run --rm \
      -e PGHOST -e PGPORT -e PGUSER -e PGPASSWORD -e PGDATABASE -e PGSSLMODE \
      postgres:17 bash -lc 'psql -c "\conninfo"'

# Dump with dockerized pg_dump 17 (Supabase direct connection)
- name: Dump with dockerized pg_dump 17
  env:
    PGHOST:     ${{ secrets.PGHOST }}
    PGPORT:     ${{ secrets.PGPORT }}
    PGUSER:     ${{ secrets.PGUSER }}
    PGPASSWORD: ${{ secrets.PGPASSWORD }}
    PGDATABASE: ${{ secrets.PGDATABASE }}
    PGSSLMODE:  require
  run: |
    docker run --rm -v "$PWD:/dump" \
      -e PGHOST -e PGPORT -e PGUSER -e PGPASSWORD -e PGDATABASE -e PGSSLMODE \
      postgres:17 bash -lc 'pg_dump --format=custom --no-owner -f /dump/backup.dump'

# Upload the dump as an artifact
- name: Upload backup artifact
  uses: actions/upload-artifact@v4
  with:
    name: db-backup
    path: backup.dump
    if-no-files-found: error
